---
title: "02_clean.qmd"
format: html
editor: visual
author: "Anna Boateng: s175562, Marlies Goedknegt: s220675, Anne Gjelstrup: s194530, Katja Jagd: s185395, Olivia Ronnenberg: s183359"
---

## Part 02: clean

#### Import the required packages

```{r}

#| label: load packages
#| echo: false
#| message: false

library("tidyverse")
library("patchwork")

```

#### Cleaning of co-expression data

As stated before, data table 1 contains data on 20 co-expression modules. In the code below, the table is tidied, so that each column represents a single module, and the row lists all genes within that given module.

#### Cleaning of table 1

```{r}

#| label: cleaning data table 1

coexpression_clean <- coexpression_load |>
  add_column(genenr = str_c("gene_",
                            seq(from = 1,
                                to = 5585)),
# the second value is determined by the longest column in the data table with nrow(coexpression_load), aka the module with the highest number of genes
             .before = "Module 1") |>
  pivot_longer(cols = -genenr,
               names_to = "modules",
               values_to = "gene") |>
  pivot_wider(names_from = genenr,
              values_from = gene)

```

#### Cleaning of table 3

##### Before treatment

The headers of the regulators data are corrected and the column called "Mechanistic Network" is excluded from the data, since it is not relevant for further analysis.

```{r}

#| label: Correcting headers (before)
#| echo: false

regulators_before_clean <- regulators_before_load |>
  set_names(as.character(slice(regulators_before_load, 1))) |>
  slice(-1) |>
  select(!c("Mechanistic Network", "Predicted Activation State", "Activation z-score")) |>
  set_names(as.character(c("Upstream Regulator", "Expr Log Ratio (before)", "Molecule Type (before)", "p-value of overlap (before)", "Target molecules in dataset (before)")))

```

```{r}

#| label: removal of p-values above 0.05 (before)

p_value_removal_before <- regulators_before_clean |> 
  filter(as.numeric(`p-value of overlap (before)`) <= 0.05)

p_value_removal_before

```

```{r}

#| label: removal of log2(fold-change) above or below 1.5 (before)

log_fold_removal_before <- p_value_removal_before |> 
  filter(as.numeric(`Expr Log Ratio (before)`) > 1.5 | (`Expr Log Ratio (before)`) < -1.5)

log_fold_removal_before

```


```{r}
#| label: split of data (before)
split_expression_before <- log_fold_removal_before |> 
  select(!"Target molecules in dataset (before)")

split_target_before <- log_fold_removal_before |> 
  select(c("Upstream Regulator","Target molecules in dataset (before)"))
```


```{r}

#| label: Counting target molecules (before)

target_molecule_count_before <- split_target_before |>
  mutate("Number of target molecules (before)" = str_count(`Target molecules in dataset (before)`, 
                           pattern = ",") + 1) |>
  select(-`Target molecules in dataset (before)`)


regulators_before_clean <- regulators_before_clean |>
  separate("Target molecules in dataset (before)",
           str_c("Target molecule_",
                 seq(from = 1, to = regulators_before_clean |>
                       slice(1) |>
                       pull(Count))),
                 ",",
                 remove = TRUE,
                 extra = "warn",
                 fill = "warn") |>
  select(-Count)


```

##### After treatment

As with the data regulators from before treatment the headers are corrected and the column called "Mehcanistic Network" is removed.

```{r}

#| label: Correcting headers (after)
#| echo: false

regulators_before_clean <- regulators_before_load |>
  set_names(as.character(slice(regulators_before_load, 1))) |>
  slice(-1) |>
  select(!c("Mechanistic Network", "Predicted Activation State", "Activation z-score")) |>
  set_names(as.character(c("Upstream Regulator", "Expr Log Ratio (after)", "Molecule Type (after)", "p-value of overlap (after)", "Target molecules in dataset (after)")))

```

```{r}
#| label: seperation of the target molecule column

count <- regulators_after_clean |> 
  mutate(length_TM = str_count(`Target molecules in dataset (after)`,
                               pattern =",")+1) |> 
  arrange(desc(length_TM))
  
regulators_after_clean1 <- count |> 
  separate(col = "Target molecules in dataset (after)",
           into = str_c("Target molecule_",
                 seq(from=1, to= count |> slice(1) %>%
  pull(length_TM))),
           ",",
           remove = TRUE,
           extra = "warn",
           fill = "warn") |> 
  select(!"length_TM")
regulators_after_clean1
```

```{r}
#| label: pivot longer 
pivot_after_treatment <- regulators_after_clean1 |> 
  pivot_longer(cols = starts_with("Target"),
               names_to = "Target_n",
               values_to = "Target")
pivot_after_treatment
```

```{r}
#| label: remove redundant variables and na (after)

tidy_pivot <- pivot_after_treatment |> 
  select(-"Target_n") |> 
  drop_na("Target") |> 
  distinct()
```


```{r}
#| label: removal of p-values above 0.05 (after)

p_value_removal_after <- tidy_pivot |> 
  filter(as.numeric(`p-value of overlap`) <= 0.05)
p_value_removal_after
```

```{r}
#| label: removal of log2(fold-change) above or below 1.5 (after)
log_fold_removal_after <- p_value_removal_after |> 
  filter(as.numeric(`Expr Log Ratio`) > 1.5 | (`Expr Log Ratio`) < -1.5)
log_fold_removal_after
```

```{r}
#| label: split of data (after)
split_expression_after <- log_fold_removal_after |> 
  select(!"Target (after)")

split_target_after <- log_fold_removal_after |> 
  select(c("Upstream Regulator","Target (after)"))
```


##### Joining of expression data 


```{r}
regulators_before_after_data <- log_fold_removal_before |> 
  inner_join(log_fold_removal_after,
             by = "Upstream Regulator", 
             relationship = "many-to-many") 
```

##### Joining of target data

