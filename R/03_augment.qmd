---
title: "03_augment.qmd"
format: html
editor: visual
author: "Anna Boateng: s175562, Marlies Goedknegt: s220675, Anne Gjelstrup: s194530, Katja Jagd: s185395, Olivia Ronnenberg: s183359"
---

## Part 03: augment

The third part of the project is to augment the cleaned data.

### Import required packages

```{r}
#| label: load packages
#| message: false

library("tidyverse")

```

The cleaned data files are loaded in.

```{r}
#| label: load data

coexpression_aug <- read_tsv("../data/02_coexpression_clean.tsv.gz",
                               show_col_types = FALSE)
expr_intersect_aug <- read_tsv("../data/02_expr_intersect_clean.tsv.gz",
                     show_col_types = FALSE)
target_intersect_aug <- read_tsv("../data/02_target_intersect_clean.tsv.gz",
                       show_col_types = FALSE)

```

The chuck below can be deleted if we dont want the volcano plots as discused friday 24th Nov.

```{r}
expr_before_aug <- read_tsv("../data/02_expr_before_clean.tsv.gz",
                               show_col_types = FALSE)

expr_after_aug <- read_tsv("../data/02_expr_after_clean.tsv.gz",
                               show_col_types = FALSE)
```

The chuck below can be deleted if we dont want the volcano plots as discused friday 24th Nov.

```{r}
expr_before_aug <- expr_before_aug |>
  mutate(is_significant = case_when(p_value_of_overlap_before <= 0.05 &
                                    expr_log_ratio_before > 1.5  ~ "yes",
                                    p_value_of_overlap_before <= 0.05 &
                                    expr_log_ratio_before < -1.5  ~ "yes")) |> 
  mutate(is_significant = coalesce(is_significant, "no")) 
```

The chuck below can be deleted if we dont want the volcano plots as discused friday 24th Nov.

```{r}
expr_after_aug <- expr_after_aug |>
  mutate(is_significant = case_when(p_value_of_overlap_after <= 0.05 &
                                    expr_log_ratio_after > 1.5  ~ "yes",
                                    p_value_of_overlap_after <= 0.05 &
                                    expr_log_ratio_after < -1.5  ~ "yes")) |> 
  mutate(is_significant = coalesce(is_significant, "no")) 
```

The chuck below can be deleted if we dont want the volcano plots as discused friday 24th Nov.

```{r}
 expr_before_aug <- expr_before_aug |>
  mutate(log10_p_value_before = -log10(p_value_of_overlap_before))
```

The chuck below can be deleted if we dont want the volcano plots as discused friday 24th Nov.

```{r}
 expr_after_aug <- expr_after_aug |>
  mutate(log10_p_value_after = -log10(p_value_of_overlap_after))
```

### Augment the dataframes

No new variables were added to the dataframe containing the coexpression data.

#### Augment the dataframe containing gene expression levels

A variable indicating whether a regulator was up- or down-regulated both before and after treatment was added.

```{r}

#| label: add column showing up- or downregulation 

expr_intersect_aug <- expr_intersect_aug |>
  mutate(regulation = case_when( expr_log_ratio_before < expr_log_ratio_after ~ "Upregulated",
                                 expr_log_ratio_before > expr_log_ratio_after ~ "Downregulated"))
```

Furthermore, a variable that shows the level of change in gene expression for the regulators was added.

```{r}
#| label: add change in expr column 

expr_intersect_aug <- expr_intersect_aug |>
  mutate(change_in_expr = expr_log_ratio_after - expr_log_ratio_before)

```

Changing all names of upstream regulators that has several names, e.g. "KLRC4-KLRK1/KLRK1" becomes "KLRK1"

```{r}
expr_intersect_aug <- expr_intersect_aug |> 
  mutate(upstream_regulator = str_replace(upstream_regulator, ".*/", ""))

target_intesect_aug <- target_intersect_aug |> 
  mutate(upstream_regulator = str_replace(upstream_regulator, ".*/", ""))
```

### Augment the dataframe containing the target molecules

A variable called change_in_n_molecules showing the difference in target molecules after treatment compared to before treatment for each regulator was added along with a classification variable called change_class that determines if the change in molecules leads to a increase, decrease or unchange of target molecules.

```{r}
target_intersect_aug <- target_intersect_aug |> 
  mutate(mol_change = n_after - n_before,
         change_class = case_when(mol_change > 0 ~ "Increase",
                              mol_change < 0 ~  "Decrease",
                              mol_change == 0 ~ "Unchaged")) |> 
  relocate(mol_change, 
           change_class,
           .after = n_after) |> 
  arrange(desc(upstream_regulator)) 
```

### Saving the augmented data frames in new files

Lastly, the augmented dataframes were saved as zipped tsv files.

```{r}
#| label: tsv files

write_tsv(coexpression_aug,
          "../data/03_coexpression_aug.tsv.gz")

write_tsv(expr_intersect_aug,
          "../data/03_expr_intersect_aug.tsv.gz")

write_tsv(target_intersect_aug,
          "../data/03_target_intersect_aug.tsv.gz")

write_tsv(expr_before_aug,
          "../data/03_expr_before_aug.tsv.gz")

write_tsv(expr_after_aug,
          "../data/03_expr_after_aug.tsv.gz")
```
